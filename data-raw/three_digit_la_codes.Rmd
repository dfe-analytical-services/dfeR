---
title: "three_digit_la_codes"
output: html_document
knitr: 
  eval: FALSE
---

## Background 

This is documentation that shows the process used to add the three digit local authority codes to the wd_pcon_lad_la_rgn_ctry look up.

## Step by step guide 

The following is a step by step guide to how the data for the local authorities is generated. There is a code chunk after the steps that shows the code used to get the three digit codes for local authorities and join them on to the wd_pcon_lad_la_rgn_ctry look up.

1.  Download the three digit local authority code tables from the [Get Information about Schools](https://get-information-schools.service.gov.uk/) (GIAs) website by going to the [Local authority name and associated codes page](https://get-information-schools.service.gov.uk/Guidance/LaNameCodes), scrolling to the bottom and clicking on the 'Download' button.

    -   Save those tables in the 'data' folder of the dfeR repo. This step is temporary.

2.  Check the those tables against the data we have in the [Explore Education Statistics screener repository](https://github.com/dfe-analytical-services/dfe-published-data-qa/blob/main/data/las.csv) to pull any codes that are missing from the GIAs data.

3.  Combine the data to create a master list of local authorities with three and nine digit codes.

4.  Join the local authorities data onto the wd_pcon_lad_la_rgn_ctry look up

```{r}

# Load and clean LA code data from a file
load_la_codes <- function(file_path) {
  #read in data 
  data.table::fread(file_path) %>%
    #rename columns 
    dplyr::rename(
      la_name = 1,
      old_la_code = 2,
      new_la_code = 3
    )
}

# Combine all LA code data
all_la_codes <- dplyr::bind_rows(
  load_la_codes("data/EnglishLaNameCodes.csv"),
  load_la_codes("data/WelshLaNameCodes.csv"),
  load_la_codes("data/OtherLaNameCodes.csv")
) %>%
  #clean up the strings in the la_name column 
  dplyr::mutate(
    la_name = gsub("^[A-Za-z]+ [A-Za-z]+ \\([^)]*\\) ", "", la_name),
    la_name = gsub("^[A-Za-z]+-LGR [0-9]+ ", "", la_name),
    old_la_code = as.character(old_la_code)
  )

# Identify missing LA codes from screener data
missing_3_digit_la_codes <- all_la_codes %>%
  dplyr::full_join(
    data.table::fread("data/las.csv") %>%
      dplyr::select(new_la_code, la_name, screener_old_la_code = old_la_code),
    by = c("la_name", "new_la_code")
  ) %>%
  dplyr::filter(is.na(old_la_code) & !is.na(screener_old_la_code)) %>%
  dplyr::filter(screener_old_la_code != "x") %>%
  dplyr::select(-old_la_code) %>%
  dplyr::rename(old_la_code = screener_old_la_code) %>%
  dplyr::distinct()

# Final GIAS LA codes including missing ones
gias_3_digit_la_codes <- all_la_codes %>%
  dplyr::bind_rows(missing_3_digit_la_codes)


```

## Get a list of missing three digit LA codes

-   Download the tables used for the three digit LA codes by going to the [Local authority name and associated codes page](https://get-information-schools.service.gov.uk/Guidance/LaNameCodes), scrolling to the bottom and clicking on the 'Download' button.

    -   You will need to download all three options (English, Welsh and other local authorities).

-   

-   You'll need to download all three options (English, Welsh and other local authorities).

```{r}
missing_3_digit_la_codes <- data.table::fread("data/EnglishLaNameCodes.csv") %>% 
  #rename columns so the binding works
  dplyr::rename(
    la_name=1,
    old_la_code = 2,
    new_la_code = 3
  ) %>%
  #bind the welsh table after formatting  
  dplyr::bind_rows(
    data.table::fread("data/WelshLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>%
  #bind the 'other' table after formatting
  dplyr::bind_rows(
    data.table::fread("data/OtherLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>% 
  #clean up the strings in the la_name column 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+ [A-Za-z]+ \\([^)]*\\) ","", la_name)) %>% 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+-LGR [0-9]+ ","", la_name)) %>% 
  dplyr::mutate(old_la_code=as.character(old_la_code)) %>%
  #left join the screener data
  dplyr::full_join(data.table::fread("data/las.csv") %>% 
                     dplyr::select(new_la_code,
                                   la_name,
                                   screener_old_la_code= old_la_code),
                   by= c("la_name"="la_name",
                         "new_la_code"= "new_la_code")) %>% 
  #filter for the ones missing from the new tables
  dplyr::filter(is.na(old_la_code) & !is.na(screener_old_la_code)) %>% 
  #filter to remove the ones with 'x's
  dplyr::filter(screener_old_la_code !="x") %>% 
  #remove the old_la_code column from the gias data and rename the screener column so it's called 'old_la_code'
  dplyr::select(-old_la_code) %>% 
  dplyr::rename(old_la_code = screener_old_la_code) %>% 
  dplyr::distinct()

```

## Source of the data and how to download it

### Source

-   This data is sourced from the [Get Information about Schools](https://get-information-schools.service.gov.uk/) website.

### How to download the data

-   You can download the tables used for the three digit LA codes by going to the [Local authority name and associated codes page](https://get-information-schools.service.gov.uk/Guidance/LaNameCodes), scrolling to the bottom and clicking on the 'Download' button.

-   You'll need to download all three options (English, Welsh and other local authorities).

```{r}
gias_3_digit_la_codes <- data.table::fread("data/EnglishLaNameCodes.csv") %>% 
  #rename columns so the binding works
  dplyr::rename(
    la_name=1,
    old_la_code = 2,
    new_la_code = 3
  ) %>%
  #bind the welsh table after formatting  
  dplyr::bind_rows(
    data.table::fread("data/WelshLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>%
  #bind the 'other' table after formatting
  dplyr::bind_rows(
    data.table::fread("data/OtherLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>% 
  dplyr::mutate(old_la_code=as.character(old_la_code)) %>%
  
  #bind rows from the screener data
  
  dplyr::bind_rows(missing_3_digit_la_codes) %>% 
  #clean up the strings in the la_name column 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+ [A-Za-z]+ \\([^)]*\\) ","", la_name)) %>% 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+-LGR [0-9]+ ","", la_name)) 

# Write the data into the package ---------------------------------------------
usethis::use_data(gias_3_digit_la_codes, overwrite = TRUE)
```
