---
title: "three_digit_la_codes"
output: html_document
knitr: 
  eval: FALSE
---

## Source of the data and how to download it

### Source

-   This data is sourced from the [Get Information about Schools](https://get-information-schools.service.gov.uk/) website.

### How to download the data

-   You can download the tables used for the three digit LA codes by going to the [Local authority name and associated codes page](https://get-information-schools.service.gov.uk/Guidance/LaNameCodes), scrolling to the bottom and clicking on the 'Download' button.

-   You'll need to download all three options (English, Welsh and other local authorities).

```{r}
gias_3_digit_la_codes <- data.table::fread("data/EnglishLaNameCodes.csv") %>% 
  #rename columns so the binding works
  dplyr::rename(
    la_name=1,
    old_la_code = 2,
    new_la_code = 3
  ) %>%
  #bind the welsh table after formatting  
  dplyr::bind_rows(
    data.table::fread("data/WelshLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>%
  #bind the 'other' table after formatting
  dplyr::bind_rows(
    data.table::fread("data/OtherLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>% 
  dplyr::mutate(old_la_code=as.character(old_la_code)) %>%
  
  #bind rows from the screener data
  
  dplyr::bind_rows(missing_3_digit_la_codes) %>% 
  #clean up the strings in the la_name column 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+ [A-Za-z]+ \\([^)]*\\) ","", la_name)) %>% 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+-LGR [0-9]+ ","", la_name)) 

# Write the data into the package ---------------------------------------------
usethis::use_data(gias_3_digit_la_codes, overwrite = TRUE)
```

## Get a list of missing three digit LA codes 

-   Download the tables used for the three digit LA codes by going to the [Local authority name and associated codes page](https://get-information-schools.service.gov.uk/Guidance/LaNameCodes), scrolling to the bottom and clicking on the 'Download' button.

-   You'll need to download all three options (English, Welsh and other local authorities).

```{r}
missing_3_digit_la_codes <- data.table::fread("data/EnglishLaNameCodes.csv") %>% 
  #rename columns so the binding works
  dplyr::rename(
    la_name=1,
    old_la_code = 2,
    new_la_code = 3
  ) %>%
  #bind the welsh table after formatting  
  dplyr::bind_rows(
    data.table::fread("data/WelshLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>%
  #bind the 'other' table after formatting
  dplyr::bind_rows(
    data.table::fread("data/OtherLaNameCodes.csv") %>% 
      dplyr::rename(
        la_name=1,
        old_la_code = 2,
        new_la_code = 3
      )
  ) %>% 
  #clean up the strings in the la_name column 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+ [A-Za-z]+ \\([^)]*\\) ","", la_name)) %>% 
  dplyr::mutate(la_name = gsub("^[A-Za-z]+-LGR [0-9]+ ","", la_name)) %>% 
  dplyr::mutate(old_la_code=as.character(old_la_code)) %>%
  #left join the screener data
  dplyr::full_join(data.table::fread("data/las.csv") %>% 
                     dplyr::select(new_la_code,
                                   la_name,
                                   screener_old_la_code= old_la_code),
                   by= c("la_name"="la_name",
                         "new_la_code"= "new_la_code")) %>% 
  #filter for the ones missing from the new tables
  dplyr::filter(is.na(old_la_code) & !is.na(screener_old_la_code)) %>% 
  #filter to remove the ones with 'x's
  dplyr::filter(screener_old_la_code !="x") %>% 
  #remove the old_la_code column from the gias data and rename the screener column so it's called 'old_la_code'
  dplyr::select(-old_la_code) %>% 
  dplyr::rename(old_la_code = screener_old_la_code) %>% 
  dplyr::distinct()

```

## 
